plugins {
	// [KR] 'fabric-loom' 플러그인을 사용하여 최신 개발 환경을 구성합니다.
	id 'fabric-loom' version "${loom_version}"
	id 'maven-publish'
}

/**
 * [KR] Git 태그를 기반으로 버전을 가져오되, 실패 시 안전한 기본값을 반환합니다.
 */
def getModVersion() {
	try {
		def stdout = new ByteArrayOutputStream()
		exec {
			commandLine 'git', 'describe', '--tags', '--always'
			standardOutput = stdout
			ignoreExitValue = true
		}
		String gitVersion = stdout.toString().trim()
		if (gitVersion.isEmpty()) return project.mod_version
		if (gitVersion.startsWith("v")) gitVersion = gitVersion.substring(1)
		return gitVersion
	} catch (Exception e) {
		return project.mod_version
	}
}

// [KR] 프로젝트 정보 설정
version = getModVersion()
group = project.maven_group

base {
	// [KR] 파일 이름을 'quite-logical'로 고정합니다.
	// 빌드 시 [archivesName]-[version].jar 형식으로 자동 생성됩니다.
	// [EN] Set the base name to 'quite-logical'.
	// The build will result in [archivesName]-[version].jar automatically.
	archivesName = "quite-logical"
}

fabricApi {
	configureDataGeneration {
		client = true
	}
}

loom {
	// [KR] 액세스 와이드너 설정
	accessWidenerPath = file("src/main/resources/qlogic.accesswidener")
}

dependencies {
	// [KR] Minecraft 및 매핑 설정
	minecraft "com.mojang:minecraft:${project.minecraft_version}"

	// [KR] 'non-obfuscated environment' 오류 해결을 위해 가장 표준적인 호출 방식을 사용합니다.
	mappings loom.officialMojangMappings()

	modImplementation "net.fabricmc:fabric-loader:${project.loader_version}"
	modImplementation "net.fabricmc.fabric-api:fabric-api:${project.fabric_api_version}"
}

processResources {
	// [KR] 빌드 시 버전을 fabric.mod.json에 자동으로 주입합니다.
	inputs.property "version", project.version

	filesMatching("fabric.mod.json") {
		expand "version": project.version
	}
}

tasks.withType(JavaCompile).configureEach {
	// [KR] Java 21 릴리즈 표준을 준수합니다.
	it.options.release = 21
}

java {
	// [KR] 소스 코드 JAR 파일도 함께 생성합니다.
	withSourcesJar()
	sourceCompatibility = JavaVersion.VERSION_21
	targetCompatibility = JavaVersion.VERSION_21
}

jar {
	// [KR] JAR 파일 내부에 라이선스 파일을 포함합니다.
	from("LICENSE") {
		rename { "${it}_${project.base.archivesName.get()}" }
	}

	// [KR] 결과 파일명을 더 명시적으로 제어하고 싶다면 아래 설정을 사용할 수 있습니다.
	// archiveFileName = "quite-logical-${project.version}.jar"
}

// [KR] Maven 배포 설정
publishing {
	publications {
		create("mavenJava", MavenPublication) {
			artifactId = "quite-logical"
			from components.java
		}
	}
}